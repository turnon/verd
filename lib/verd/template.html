<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>erd</title>
  <style>
    html,
    body,
    #graph {
      height: 100%;
      overflow: hidden;
    }
  </style>
  <link rel="stylesheet" type="text/css" href="http://unpkg.com/view-design/dist/styles/iview.css">
  <script type="text/javascript" src="http://vuejs.org/js/vue.min.js"></script>
  <script type="text/javascript" src="http://unpkg.com/view-design/dist/iview.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/echarts@4.1.0/dist/echarts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue-echarts@4.0.2"></script>
</head>

<body>
  <div id="filter-panel">
    <Drawer placement="left" v-model="filter" :mask-closable="false" :mask="false" :draggable="true" :transfer="false">
      <Tree :data="relations" show-checkbox @on-check-change="selectRelation($event)" />
    </Drawer>
    <Button @click="filter = !filter" type="primary">Open</Button>
  </div>

  <div id="graph">
    <v-chart :options="opts" theme="light" autoresize />
  </div>

  <script>
    (function () {

      let graph =
      //start-sub
      {
        "nodes": [{ "name": "n1", "category": 0 }, { "name": "n2", "category": 1 }, { "name": "n3", "category": 2 }, { "name": "n4", "category": 2 }],
        "links": [{ "id": 0, "source": "n1", "target": "n2" }, { "id": 1, "source": "n2", "target": "n3" }, { "id": 2, "source": "n3", "target": "n1" }, { "id": 3, "source": "n3", "target": "n4" }],
        "categories": [{ "name": "/A" }, { "name": "/B" }, { "name": "/C" }]
      }
      //end-sub

      let group_by_src = {},
        add_to_group = (link, i) => {
          if (!group_by_src[link.source]) {
            group_by_src[link.source] = {
              title: link.source,
              expand: true,
              children: []
            }
          }
          group_by_src[link.source].children.push({
            link_idx: i,
            title: link.target
          })
        }

      graph.links.forEach((link, i) => {
        link.lineStyle = { opacity: 0.5, width: 1 }
        add_to_group(link, i)
      })

      graph.nodes.forEach((node, i) => {
        node.itemStyle = { opacity: 1 }
      })

      let relations = Object.values(group_by_src)

      new Vue({
        el: '#filter-panel',
        data: {
          filter: false,
          relations: relations
        },
        methods: {
          selectRelation(checkeds) {
            let checked_links = new Set(),
              checked_nodes = new Set()

            checkeds.forEach((c) => {
              if (c.link_idx) {
                checked_links.add(c.link_idx)
                checked_nodes.add(graph.links[c.link_idx].source)
              }
              checked_nodes.add(c.title)
            })

            if (checked_nodes.size === 0) {
              graph.links.forEach((link) => {
                link.lineStyle.width = 1
                link.lineStyle.opacity = 1
              })
              graph.nodes.forEach((node) => {
                node.itemStyle.opacity = 1
              })
              return
            }

            graph.links.forEach((link, i) => {
              if (checked_links.has(i)) {
                link.lineStyle.width = 10
                link.lineStyle.opacity = 1
              } else {
                link.lineStyle.width = 1
                link.lineStyle.opacity = 0.1
              }
            })

            graph.nodes.forEach((node, i) => {
              if (checked_nodes.has(node.name)) {
                node.itemStyle.opacity = 1
              } else {
                node.itemStyle.opacity = 0.1
              }
            })
          }
        }
      })

      Vue.component('v-chart', VueECharts)
      new Vue({
        el: '#graph',
        data: {
          opts: {
            // title: {
            //   text: 'Les Miserables',
            //   subtext: 'Default layout',
            //   top: 'bottom',
            //   left: 'right'
            // },
            tooltip: {},
            legend: [{
              // selectedMode: 'single',
              data: graph.categories.map(function (a) {
                return a.name;
              })
            }],
            animationDuration: 1500,
            animationEasingUpdate: 'quinticInOut',
            series: [{
              name: 'Les Miserables',
              type: 'graph',
              layout: 'force',
              data: graph.nodes,
              links: graph.links,
              categories: graph.categories,
              roam: true,
              // focusNodeAdjacency: true,
              itemStyle: {
                borderColor: '#fff',
                borderWidth: 1,
                shadowBlur: 10,
                shadowColor: 'rgba(0, 0, 0, 0.3)'
              },
              label: {
                position: 'right',
                formatter: '{b}'
              },
              lineStyle: {
                color: 'source',
                // curveness: 0.3
              },
              edgeSymbolSize: 15,
              emphasis: {
                lineStyle: {
                  width: 10
                }
              }
            }]
          }
        },
        methods: {}
      })

      setTimeout(() => {
        let chart = document.querySelector(".echarts")
        chart.style.width = "100%"
        chart.style.height = "100%"
      })
    })()
  </script>
</body>

</html>